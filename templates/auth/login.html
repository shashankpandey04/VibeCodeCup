{% extends 'base.html' %}
{% block content %}
<div class="container mx-auto px-6 min-h-screen flex items-center justify-center pt-24">
    <div class="w-full max-w-md neo-brutalism p-10" data-aos="fade-up">
        <h2 class="text-3xl font-bold glitch mb-8 text-center">Login</h2>

        <!-- Alert area -->
        <div id="auth-alert" class="hidden mb-4 px-4 py-3 rounded text-sm" role="alert"></div>

        <form id="login-form" method="post" action="/auth/login" class="space-y-8">
            <div>
                <label class="block text-text mb-2 font-bold tracking-wide text-sm uppercase" for="email">Email</label>
                <input class="w-full px-4 py-3 bg-surface border-2 border-primary text-text rounded focus:outline-none focus:border-secondary transition-all duration-200" 
                       type="email" 
                       id="email" 
                       name="email" 
                       required 
                       autocomplete="username">
            </div>
            <div>
                <label class="block text-text mb-2 font-bold tracking-wide text-sm uppercase" for="password">Password</label>
                <input class="w-full px-4 py-3 bg-surface border-2 border-primary text-text rounded focus:outline-none focus:border-secondary transition-all duration-200" 
                       type="password" 
                       id="password" 
                       name="password" 
                       required 
                       autocomplete="current-password">
            </div>
            <button id="login-btn" class="w-full neo-brutalism hover-glow py-4 font-bold text-lg uppercase tracking-wider" type="submit">
                Enter â†’
            </button>
        </form>
        <div class="mt-8 text-center">
            <p class="text-text/80">Don't have an account?</p>
            <a href="/auth/register" class="inline-block mt-2 gradient-text hover-glow font-bold">Register Now</a>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const form = document.getElementById('login-form');
    const btn = document.getElementById('login-btn');
    const alertBox = document.getElementById('auth-alert');

    function showAlert(message, type = 'error') {
        alertBox.classList.remove('hidden', 'bg-red-100', 'text-red-800', 'bg-green-100', 'text-green-800', 'border', 'border-red-300', 'border-green-300');
        if (type === 'success') {
            alertBox.classList.add('bg-green-100', 'text-green-800', 'border', 'border-green-300');
        } else {
            alertBox.classList.add('bg-red-100', 'text-red-800', 'border', 'border-red-300');
        }
        alertBox.textContent = message;
    }

    function clearAlert() {
        alertBox.classList.add('hidden');
        alertBox.textContent = '';
    }

    form.addEventListener('submit', async function (e) {
        e.preventDefault();
        clearAlert();

        const formData = new FormData(form);

        btn.disabled = true;
        const originalText = btn.textContent;
        btn.textContent = 'Entering...';

        try {
            const res = await fetch(form.action, {
                method: 'POST',
                body: formData,
                credentials: 'same-origin',
                headers: {
                    'Accept': 'application/json'
                }
            });

            let payload;
            try {
                payload = await res.json();
            } catch (err) {
                showAlert('Unexpected server response. Try again later.');
                btn.disabled = false;
                btn.textContent = originalText;
                return;
            }

            if (payload && payload.status === 'success') {
                showAlert(payload.message || 'Logged in successfully.', 'success');
                // small delay to show success message, then navigate
                setTimeout(() => {
                    window.location.href = '/dashboard';
                }, 400);
            } else {
                const msg = (payload && payload.message) ? payload.message : 'Invalid email or password.';
                showAlert(msg, 'error');
                btn.disabled = false;
                btn.textContent = originalText;
            }
        } catch (err) {
            showAlert('Network error. Please try again.');
            btn.disabled = false;
            btn.textContent = originalText;
        }
    });
});
</script>
{% endblock %}
